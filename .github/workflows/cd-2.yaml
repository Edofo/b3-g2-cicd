name: CD Pipeline 2

on:
    workflow_dispatch:
        inputs:
            version_type:
                type: choice
                description: "The type of version to deploy"
                required: true
                default: "patch"
                options:
                    - patch
                    - minor
                    - major

jobs:
    install:
        permissions:
            id-token: write
            contents: read
            attestations: write

        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Install dependencies
              run: npm ci
            - name: Export artifact
              uses: actions/upload-artifact@v4
              with:
                name: cicd-artifact
                path: node_modules
    
    lint:
        runs-on: ubuntu-latest
        needs: install
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Install dependencies
              run: npm ci

            # - name: Download artifact
            #   uses: actions/download-artifact@v5
            #   with:
            #     name: cicd-artifact

            - name: Run lint
              run: npm run lint

    test:
        runs-on: ubuntu-latest
        needs: install
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Install dependencies
              run: npm ci

            # - name: Download artifact
            #   uses: actions/download-artifact@v4
            #   with:
            #     name: cicd-artifact
            #     path: ./artifacts

            - name: Run test
              run: npm run test
    
    release:
        runs-on: ubuntu-latest
        needs: [lint, test]
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 22

            - name: Configure Git
              run: |
                git config --global user.name "GitHub Actions"
                git config --global user.email "github-actions@github.com"

            - name: Bump version
              run: |
                npm version ${{ inputs.version_type }}

            - name: Commit changes
              run: |
                git add .
                git commit -m "Bump version to ${{ inputs.version_type }}"
                git push origin HEAD
                git push origin --tags

            - name: Create release
              run: |
                gh release create v${{ inputs.version_type }} --generate-notes